name: AI Assistant Rulesync

on:
  pull_request:
    paths:
      - '.rulesync/**'
      - '.cursor/**'
      - '.cursorignore'
      - '.claude/**'
      - 'rulesync.jsonc'
      - '.rulesyncignore'
  push:
    branches:
      - 'main'
      - 'release-*'
    paths:
      - '.rulesync/**'
      - '.cursor/**'
      - '.cursorignore'
      - '.claude/**'
      - 'rulesync.jsonc'
      - '.rulesyncignore'

jobs:
  rulesync:
    name: Generate and check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version-file: ".nvmrc"

      - name: Install dependencies
        run: yarn install

      - name: Run rulesync generate
        run: yarn rulesync:generate

      - name: Verify generated files are in sync
        uses: tj-actions/verify-changed-files@a1c6acee9df209257a246f2cc6ae8cb6581c1edf # v20
        id: verify-changed-files
        with:
          files: |
            .cursor/**
            .claude/**
            .cursorignore
            .rulesyncignore

      - name: Report out-of-sync files
        if: steps.verify-changed-files.outputs.files_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.verify-changed-files.outputs.changed_files }}
        run: |
          echo "‚ùå Generated files are out of sync with .rulesync!"
          echo "üìã Files with differences: $CHANGED_FILES"
          echo "üîß To fix this, run:"
          echo "  - yarn rulesync:generate if you forgot to generate the files from .rulesync"
          echo "  - yarn rulesync:import:cursor if you edited .cursor files directly"
          echo "  - yarn rulesync:import:claude if you edited .claude files directly"
          echo "  and then commit the changes"
          exit 1
