#!/usr/bin/env node

/**
 * Regenerates OWNERS_ALIASES from GitHub team membership.
 *
 * Environment variables:
 * - GITHUB_TOKEN: token with at least read:org scope (optional for public teams)
 */

import fs from "node:fs";
import path from "node:path";

const repoRoot = process.cwd();
const OWNERS_ALIASES_FILE = "OWNERS_ALIASES";
const outputPath = path.join(repoRoot, OWNERS_ALIASES_FILE);
const GITHUB_ORG = "redhat-developer";

// List of GitHub team slugs to sync. The team slug is used as the alias name.
const TEAMS = [
  "rhdh", // this is the root team
  "rhdh-cope",
  "rhdh-plugins",
  "rhdh-security",
  "rhdh-ui",
  "rhdh-administrators",
  "rhdh-install"
];

const authToken = process.env.GITHUB_TOKEN || "";

if (!authToken) {
  console.error(
    "No GitHub token provided. Requests may be rate-limited or fail for private teams.",
  );
  process.exit(1);
}

const headers = {
  Accept: "application/vnd.github+json",
  "User-Agent": "rhdh-owners-sync-script",
  ...(authToken ? { Authorization: `Bearer ${authToken}` } : {}),
};

async function fetchTeamMembers(teamSlug) {
  const perPage = 100;
  const members = [];

  for (let page = 1; ; page += 1) {
    const url = new URL(
      `https://api.github.com/orgs/${GITHUB_ORG}/teams/${teamSlug}/members`,
    );
    url.searchParams.set("per_page", perPage.toString());
    url.searchParams.set("page", page.toString());

    const response = await fetch(url, { headers });

    if (response.status === 404) {
      throw new Error(
        `Team "${teamSlug}" not found in org "${GITHUB_ORG}". Ensure the slug is correct and the token can access it.`,
      );
    }

    if (!response.ok) {
      const body = await response.text();
      throw new Error(
        `Failed to fetch members for ${teamSlug}: ${response.status} ${response.statusText} (${body})`,
      );
    }

    const batch = await response.json();

    if (!Array.isArray(batch) || batch.length === 0) {
      break;
    }

    members.push(...batch);

    if (batch.length < perPage) {
      break;
    }
  }

  return members;
}

async function main() {
  const lines = [
    "# This file is auto-generated by scripts/generate-owners-aliases.mjs",
    "# Do not edit manually.",
    "",
    "aliases:",
  ];

  for (const teamSlug of TEAMS) {
    console.log(`Fetching members for ${GITHUB_ORG}/${teamSlug}`);

    const members = await fetchTeamMembers(teamSlug);
    const handles = members
      .map((member) => member.login)
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b));

    lines.push(`  ${teamSlug}:`);

    if (!handles.length) {
      console.warn(`  No members returned for ${teamSlug}`);
      continue;
    }

    for (const handle of handles) {
      lines.push(`    - ${handle}`);
    }
  }

  fs.writeFileSync(outputPath, `${lines.join("\n")}\n`);
  console.log(`Updated ${path.relative(repoRoot, outputPath)}`);
}

try {
  await main();
} catch (error) {
  console.error(error);
  process.exit(1);
}
